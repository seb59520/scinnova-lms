{
  "type": "resource",
  "title": "√âtape 7 - Solution compl√®te de surveillance",
  "position": 7,
  "published": true,
  "content": {
    "description": "Solution compl√®te pour la surveillance en continu d'un fichier de logs avec analyse des nouvelles lignes",
    "body": {
      "type": "doc",
      "content": [
        {
          "type": "heading",
          "attrs": { "level": 1 },
          "content": [
            { "type": "text", "text": "√âTAPE 7 - SOLUTION COMPL√àTE" }
          ]
        },
        {
          "type": "paragraph",
          "content": [
            { "type": "text", "text": "Objectif : Impl√©menter une surveillance en continu avec analyse et traitement des √©v√©nements d√©tect√©s" }
          ]
        },
        {
          "type": "heading",
          "attrs": { "level": 2 },
          "content": [
            { "type": "text", "text": "Solution compl√®te" }
          ]
        },
        {
          "type": "codeBlock",
          "attrs": { "language": "python" },
          "content": [
            {
              "type": "text",
              "text": "# ===========================================\n# √âTAPE 7 - SOLUTION COMPL√àTE DE SURVEILLANCE\n# ===========================================\n# Objectif : surveiller un fichier de logs en continu\n# et analyser/traiter les nouvelles lignes ajout√©es\n\nimport time\nimport re\nfrom datetime import datetime\nfrom collections import defaultdict\n\nLOG_FILE = \"auth.log\"\n\n# ===========================================\n# Fonction pour parser une ligne de log\n# ===========================================\ndef parse_log_line(ligne):\n    \"\"\"\n    Parse une ligne de log et extrait les informations pertinentes\n    Retourne un dictionnaire avec les donn√©es extraites ou None\n    \"\"\"\n    # Exemple de pattern pour les logs d'authentification\n    # Format typique : Jan 21 10:30:45 hostname sshd[12345]: Failed password for user from 192.168.1.100\n    \n    patterns = {\n        'failed_login': r'Failed password for (.+?) from (.+?) port',\n        'successful_login': r'Accepted password for (.+?) from (.+?) port',\n        'invalid_user': r'Invalid user (.+?) from (.+?)',\n        'connection_closed': r'Connection closed by (.+?)',\n    }\n    \n    for event_type, pattern in patterns.items():\n        match = re.search(pattern, ligne)\n        if match:\n            return {\n                'type': event_type,\n                'timestamp': datetime.now().isoformat(),\n                'line': ligne.strip(),\n                'details': match.groups()\n            }\n    \n    return None\n\n# ===========================================\n# Fonction pour traiter un √©v√©nement\n# ===========================================\ndef process_event(event):\n    \"\"\"\n    Traite un √©v√©nement d√©tect√© et prend les actions appropri√©es\n    \"\"\"\n    event_type = event['type']\n    \n    if event_type == 'failed_login':\n        username, ip = event['details']\n        print(f\"‚ö†Ô∏è  Tentative de connexion √©chou√©e pour '{username}' depuis {ip}\")\n        # Ici on pourrait :\n        # - Enregistrer dans une base de donn√©es\n        # - Envoyer une alerte\n        # - Bloquer l'IP apr√®s X tentatives\n        \n    elif event_type == 'successful_login':\n        username, ip = event['details']\n        print(f\"‚úÖ Connexion r√©ussie pour '{username}' depuis {ip}\")\n        \n    elif event_type == 'invalid_user':\n        username, ip = event['details']\n        print(f\"üö´ Tentative de connexion avec utilisateur invalide '{username}' depuis {ip}\")\n        \n    elif event_type == 'connection_closed':\n        ip = event['details'][0]\n        print(f\"üîå Connexion ferm√©e depuis {ip}\")\n\n# ===========================================\n# Fonction principale de surveillance\n# ===========================================\ndef surveiller_logs():\n    \"\"\"\n    Surveille le fichier de logs en continu\n    \"\"\"\n    print(\"üîÑ Surveillance en continu activ√©e\")\n    print(\"Appuyez sur Ctrl+C pour arr√™ter\")\n    print(\"=\" * 50)\n    \n    # Compteur d'√©v√©nements par type\n    stats = defaultdict(int)\n    \n    # On ouvre le fichier de logs en lecture\n    with open(LOG_FILE, \"r\", encoding=\"utf-8\") as f:\n        \n        # On place le curseur √† la FIN du fichier\n        # Cela √©vite de relire tout l'historique\n        f.seek(0, 2)\n        \n        # Boucle infinie : le script tourne en continu\n        while True:\n            try:\n                # On m√©morise la position actuelle dans le fichier\n                position_avant = f.tell()\n                \n                # On lit toutes les nouvelles lignes ajout√©es\n                nouvelles_lignes = f.readlines()\n                \n                # Si de nouvelles lignes ont √©t√© ajout√©es\n                if nouvelles_lignes:\n                    for ligne in nouvelles_lignes:\n                        ligne = ligne.strip()\n                        \n                        if ligne:\n                            # On parse la ligne pour extraire les infos\n                            event = parse_log_line(ligne)\n                            \n                            if event:\n                                # On traite l'√©v√©nement\n                                process_event(event)\n                                \n                                # On met √† jour les statistiques\n                                stats[event['type']] += 1\n                            else:\n                                # Ligne non reconnue, on l'affiche quand m√™me\n                                print(f\"üìÑ Ligne non analys√©e : {ligne[:80]}...\")\n                \n                else:\n                    # Aucune nouvelle ligne :\n                    # on revient √† la position pr√©c√©dente\n                    f.seek(position_avant)\n                \n                # Affichage p√©riodique des statistiques\n                if sum(stats.values()) > 0 and sum(stats.values()) % 10 == 0:\n                    print(\"\\nüìä Statistiques :\")\n                    for event_type, count in stats.items():\n                        print(f\"   {event_type}: {count}\")\n                    print()\n                \n                # Pause avant la prochaine v√©rification\n                time.sleep(1)  # V√©rification toutes les secondes\n                \n            except KeyboardInterrupt:\n                print(\"\\n\\nüõë Arr√™t de la surveillance demand√©\")\n                print(\"\\nüìä Statistiques finales :\")\n                for event_type, count in stats.items():\n                    print(f\"   {event_type}: {count}\")\n                print(f\"\\nTotal d'√©v√©nements trait√©s : {sum(stats.values())}\")\n                break\n            \n            except FileNotFoundError:\n                print(f\"‚ùå Erreur : Le fichier {LOG_FILE} n'existe pas\")\n                break\n            \n            except Exception as e:\n                print(f\"‚ùå Erreur inattendue : {e}\")\n                time.sleep(5)  # Pause plus longue en cas d'erreur\n\n# ===========================================\n# Point d'entr√©e du programme\n# ===========================================\nif __name__ == \"__main__\":\n    surveiller_logs()\n"
            }
          ]
        },
        {
          "type": "heading",
          "attrs": { "level": 2 },
          "content": [
            { "type": "text", "text": "Explications d√©taill√©es" }
          ]
        },
        {
          "type": "heading",
          "attrs": { "level": 3 },
          "content": [
            { "type": "text", "text": "1. Fonction parse_log_line()" }
          ]
        },
        {
          "type": "paragraph",
          "content": [
            { "type": "text", "text": "Cette fonction utilise des expressions r√©guli√®res pour identifier diff√©rents types d'√©v√©nements dans les logs :" }
          ]
        },
        {
          "type": "bulletList",
          "content": [
            {
              "type": "listItem",
              "content": [
                {
                  "type": "paragraph",
                  "content": [
                    { "type": "text", "text": "Connexions √©chou√©es (failed_login)" }
                  ]
                }
              ]
            },
            {
              "type": "listItem",
              "content": [
                {
                  "type": "paragraph",
                  "content": [
                    { "type": "text", "text": "Connexions r√©ussies (successful_login)" }
                  ]
                }
              ]
            },
            {
              "type": "listItem",
              "content": [
                {
                  "type": "paragraph",
                  "content": [
                    { "type": "text", "text": "Tentatives avec utilisateur invalide (invalid_user)" }
                  ]
                }
              ]
            },
            {
              "type": "listItem",
              "content": [
                {
                  "type": "paragraph",
                  "content": [
                    { "type": "text", "text": "Fermetures de connexion (connection_closed)" }
                  ]
                }
              ]
            }
          ]
        },
        {
          "type": "heading",
          "attrs": { "level": 3 },
          "content": [
            { "type": "text", "text": "2. Fonction process_event()" }
          ]
        },
        {
          "type": "paragraph",
          "content": [
            { "type": "text", "text": "Traite chaque √©v√©nement d√©tect√© et peut :" }
          ]
        },
        {
          "type": "bulletList",
          "content": [
            {
              "type": "listItem",
              "content": [
                {
                  "type": "paragraph",
                  "content": [
                    { "type": "text", "text": "Afficher des messages informatifs" }
                  ]
                }
              ]
            },
            {
              "type": "listItem",
              "content": [
                {
                  "type": "paragraph",
                  "content": [
                    { "type": "text", "text": "Enregistrer dans une base de donn√©es" }
                  ]
                }
              ]
            },
            {
              "type": "listItem",
              "content": [
                {
                  "type": "paragraph",
                  "content": [
                    { "type": "text", "text": "Envoyer des alertes (email, SMS, webhook)" }
                  ]
                }
              ]
            },
            {
              "type": "listItem",
              "content": [
                {
                  "type": "paragraph",
                  "content": [
                    { "type": "text", "text": "Bloquer des IPs suspectes automatiquement" }
                  ]
                }
              ]
            }
          ]
        },
        {
          "type": "heading",
          "attrs": { "level": 3 },
          "content": [
            { "type": "text", "text": "3. Gestion des statistiques" }
          ]
        },
        {
          "type": "paragraph",
          "content": [
            { "type": "text", "text": "Le script maintient un compteur d'√©v√©nements par type et affiche p√©riodiquement les statistiques pour avoir une vue d'ensemble de l'activit√©." }
          ]
        },
        {
          "type": "heading",
          "attrs": { "level": 3 },
          "content": [
            { "type": "text", "text": "4. Gestion des erreurs" }
          ]
        },
        {
          "type": "paragraph",
          "content": [
            { "type": "text", "text": "Le script g√®re plusieurs cas d'erreur :" }
          ]
        },
        {
          "type": "bulletList",
          "content": [
            {
              "type": "listItem",
              "content": [
                {
                  "type": "paragraph",
                  "content": [
                    { "type": "text", "text": "KeyboardInterrupt : Arr√™t propre avec Ctrl+C" }
                  ]
                }
              ]
            },
            {
              "type": "listItem",
              "content": [
                {
                  "type": "paragraph",
                  "content": [
                    { "type": "text", "text": "FileNotFoundError : Fichier de log introuvable" }
                  ]
                }
              ]
            },
            {
              "type": "listItem",
              "content": [
                {
                  "type": "paragraph",
                  "content": [
                    { "type": "text", "text": "Autres exceptions : Gestion g√©n√©rique avec pause" }
                  ]
                }
              ]
            }
          ]
        },
        {
          "type": "heading",
          "attrs": { "level": 2 },
          "content": [
            { "type": "text", "text": "Am√©liorations possibles" }
          ]
        },
        {
          "type": "bulletList",
          "content": [
            {
              "type": "listItem",
              "content": [
                {
                  "type": "paragraph",
                  "content": [
                    { "type": "text", "text": "Utiliser un syst√®me de files d'attente (queue) pour traiter les √©v√©nements de mani√®re asynchrone" }
                  ]
                }
              ]
            },
            {
              "type": "listItem",
              "content": [
                {
                  "type": "paragraph",
                  "content": [
                    { "type": "text", "text": "Impl√©menter un syst√®me de throttling pour √©viter de surcharger le syst√®me" }
                  ]
                }
              ]
            },
            {
              "type": "listItem",
              "content": [
                {
                  "type": "paragraph",
                  "content": [
                    { "type": "text", "text": "Ajouter une d√©tection d'anomalies (trop de tentatives depuis une m√™me IP)" }
                  ]
                }
              ]
            },
            {
              "type": "listItem",
              "content": [
                {
                  "type": "paragraph",
                  "content": [
                    { "type": "text", "text": "Persister les statistiques dans un fichier ou une base de donn√©es" }
                  ]
                }
              ]
            },
            {
              "type": "listItem",
              "content": [
                {
                  "type": "paragraph",
                  "content": [
                    { "type": "text", "text": "Utiliser des threads ou asyncio pour am√©liorer les performances" }
                  ]
                }
              ]
            }
          ]
        }
      ]
    }
  }
}

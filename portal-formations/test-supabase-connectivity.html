<!DOCTYPE html>
<html>
<head>
    <title>Test Connectivit√© Supabase</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; }
        .test { margin: 20px 0; padding: 15px; border: 1px solid #ddd; border-radius: 5px; }
        .success { background-color: #d4edda; border-color: #c3e6cb; }
        .error { background-color: #f8d7da; border-color: #f5c6cb; }
        .info { background-color: #d1ecf1; border-color: #bee5eb; }
        pre { background: #f4f4f4; padding: 10px; border-radius: 3px; overflow-x: auto; }
    </style>
</head>
<body>
    <h1>Test de Connectivit√© Supabase</h1>
    <p>Ouvrez la console (F12) pour voir les d√©tails</p>
    
    <div id="results"></div>
    
    <script type="module">
        (async function() {
            const resultsDiv = document.getElementById('results');
            
            function addResult(title, content, type = 'info') {
                const div = document.createElement('div');
                div.className = `test ${type}`;
                div.innerHTML = `<h3>${title}</h3><pre>${content}</pre>`;
                resultsDiv.appendChild(div);
            }
            
            // R√©cup√©rer les variables d'environnement depuis localStorage ou prompt
            let supabaseUrl = localStorage.getItem('test_supabase_url') || prompt('Entrez votre URL Supabase (ex: https://xxx.supabase.co):');
            let supabaseKey = localStorage.getItem('test_supabase_key') || prompt('Entrez votre cl√© anon Supabase:');
            
            if (supabaseUrl) localStorage.setItem('test_supabase_url', supabaseUrl);
            if (supabaseKey) localStorage.setItem('test_supabase_key', supabaseKey);
            
            if (!supabaseUrl || !supabaseKey) {
                addResult('‚ùå Configuration manquante', 'URL ou cl√© Supabase manquante', 'error');
                return;
            }
        
        addResult('‚úÖ Configuration', `URL: ${supabaseUrl}\nCl√©: ${supabaseKey.substring(0, 20)}...`, 'info');
        
        // Test 1: Connectivit√© de base
        addResult('üîÑ Test 1: Connectivit√© de base', 'Test en cours...', 'info');
        fetch(`${supabaseUrl}/rest/v1/`, {
            method: 'GET',
            headers: {
                'apikey': supabaseKey,
                'Content-Type': 'application/json'
            }
        })
        .then(response => {
            const status = response.status;
            const statusText = response.statusText;
            addResult('‚úÖ Test 1: Connectivit√© de base', `Status: ${status} ${statusText}\nLa connexion √† Supabase fonctionne!`, 'success');
            return response.text();
        })
        .catch(error => {
            addResult('‚ùå Test 1: Connectivit√© de base', `Erreur: ${error.message}\n\nV√©rifiez:\n- Que l'URL Supabase est correcte\n- Que vous √™tes connect√© √† Internet\n- Qu'il n'y a pas de firewall qui bloque`, 'error');
        })
        .then(() => {
            // Test 2: Endpoint auth
            addResult('üîÑ Test 2: Endpoint Auth', 'Test en cours...', 'info');
            return fetch(`${supabaseUrl}/auth/v1/health`, {
                method: 'GET',
                headers: {
                    'apikey': supabaseKey
                }
            });
        })
        .then(response => {
            const status = response.status;
            addResult('‚úÖ Test 2: Endpoint Auth', `Status: ${status}\nL'endpoint auth est accessible!`, 'success');
            
            // Test 3: Requ√™te profiles (sans auth)
            addResult('üîÑ Test 3: Requ√™te Profiles (sans auth)', 'Test en cours...', 'info');
            return fetch(`${supabaseUrl}/rest/v1/profiles?select=id&limit=1`, {
                method: 'GET',
                headers: {
                    'apikey': supabaseKey,
                    'Content-Type': 'application/json'
                }
            });
        })
        .then(response => {
            const status = response.status;
            const statusText = response.statusText;
            if (status === 401 || status === 403) {
                addResult('‚ö†Ô∏è Test 3: Requ√™te Profiles', `Status: ${status} ${statusText}\nC'est normal - RLS bloque l'acc√®s sans authentification`, 'info');
            } else {
                addResult('‚úÖ Test 3: Requ√™te Profiles', `Status: ${status} ${statusText}\nLa table profiles est accessible!`, 'success');
            }
            
            // Test 4: Timeout test
            addResult('üîÑ Test 4: Test de Timeout', 'Test en cours (attente 5 secondes)...', 'info');
            const controller = new AbortController();
            const timeoutId = setTimeout(() => controller.abort(), 5000);
            
            return fetch(`${supabaseUrl}/rest/v1/`, {
                method: 'GET',
                headers: {
                    'apikey': supabaseKey
                },
                signal: controller.signal
            }).finally(() => clearTimeout(timeoutId));
        })
        .then(response => {
            addResult('‚úÖ Test 4: Test de Timeout', 'La requ√™te a r√©ussi en moins de 5 secondes!', 'success');
        })
        .catch(error => {
            if (error.name === 'AbortError' || error.message.includes('timeout') || error.message.includes('aborted')) {
                addResult('‚ùå Test 4: Test de Timeout', 'La requ√™te timeout apr√®s 5 secondes!\n\nCela indique un probl√®me de r√©seau ou de configuration.', 'error');
            } else if (error.message) {
                addResult('‚ö†Ô∏è Test 2/3/4', `Erreur: ${error.message}`, 'error');
            }
        });
        
            console.log('Tests de connectivit√© Supabase lanc√©s');
            console.log('URL:', supabaseUrl);
            console.log('Cl√©:', supabaseKey.substring(0, 20) + '...');
        })();
    </script>
</body>
</html>

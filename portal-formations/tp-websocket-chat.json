{
  "type": "tp",
  "title": "TP : Application de chat avec WebSocket",
  "position": 0,
  "published": true,
  "content": {
    "instructions": {
      "type": "doc",
      "content": [
        {
          "type": "heading",
          "attrs": {
            "level": 1
          },
          "content": [
            {
              "type": "text",
              "text": "TP : Application de chat avec WebSocket"
            }
          ]
        },
        {
          "type": "paragraph",
          "content": [
            {
              "type": "text",
              "text": "Dans ce TP, vous allez cr√©er une application de chat simple utilisant WebSocket pour permettre la communication en temps r√©el entre plusieurs utilisateurs."
            }
          ]
        },
        {
          "type": "heading",
          "attrs": {
            "level": 2
          },
          "content": [
            {
              "type": "text",
              "text": "üéØ Objectifs"
            }
          ]
        },
        {
          "type": "bulletList",
          "content": [
            {
              "type": "listItem",
              "content": [
                {
                  "type": "paragraph",
                  "content": [
                    {
                      "type": "text",
                      "text": "Comprendre le fonctionnement de WebSocket"
                    }
                  ]
                }
              ]
            },
            {
              "type": "listItem",
              "content": [
                {
                  "type": "paragraph",
                  "content": [
                    {
                      "type": "text",
                      "text": "Impl√©menter une connexion WebSocket bidirectionnelle"
                    }
                  ]
                }
              ]
            },
            {
              "type": "listItem",
              "content": [
                {
                  "type": "paragraph",
                  "content": [
                    {
                      "type": "text",
                      "text": "G√©rer la reconnexion automatique en cas de perte de connexion"
                    }
                  ]
                }
              ]
            },
            {
              "type": "listItem",
              "content": [
                {
                  "type": "paragraph",
                  "content": [
                    {
                      "type": "text",
                      "text": "Impl√©menter un syst√®me de heartbeat pour maintenir la connexion active"
                    }
                  ]
                }
              ]
            }
          ]
        },
        {
          "type": "heading",
          "attrs": {
            "level": 2
          },
          "content": [
            {
              "type": "text",
              "text": "üìã √âtapes du TP"
            }
          ]
        },
        {
          "type": "heading",
          "attrs": {
            "level": 3
          },
          "content": [
            {
              "type": "text",
              "text": "√âtape 1 : Connexion au serveur WebSocket"
            }
          ]
        },
        {
          "type": "paragraph",
          "content": [
            {
              "type": "text",
              "text": "Pour tester votre application, vous pouvez utiliser le serveur WebSocket public de websocket.org :"
            }
          ]
        },
        {
          "type": "codeBlock",
          "attrs": {
            "language": "javascript"
          },
          "content": [
            {
              "type": "text",
              "text": "const ws = new WebSocket('wss://echo.websocket.org');\n\nws.onopen = () => {\n  console.log('Connexion WebSocket √©tablie');\n};\n\nws.onerror = (error) => {\n  console.error('Erreur WebSocket:', error);\n};\n\nws.onclose = () => {\n  console.log('Connexion WebSocket ferm√©e');\n};"
            }
          ]
        },
        {
          "type": "heading",
          "attrs": {
            "level": 3
          },
          "content": [
            {
              "type": "text",
              "text": "√âtape 2 : Envoyer des messages"
            }
          ]
        },
        {
          "type": "paragraph",
          "content": [
            {
              "type": "text",
              "text": "Impl√©mentez une fonction pour envoyer des messages au serveur. Assurez-vous que la connexion est ouverte avant d'envoyer :"
            }
          ]
        },
        {
          "type": "codeBlock",
          "attrs": {
            "language": "javascript"
          },
          "content": [
            {
              "type": "text",
              "text": "function sendMessage(message) {\n  if (ws && ws.readyState === WebSocket.OPEN) {\n    const messageData = {\n      type: 'message',\n      content: message,\n      timestamp: new Date().toISOString(),\n      user: 'Utilisateur' // Vous pouvez demander le nom d'utilisateur\n    };\n    ws.send(JSON.stringify(messageData));\n  } else {\n    console.error('WebSocket n'est pas connect√©');\n  }\n}"
            }
          ]
        },
        {
          "type": "heading",
          "attrs": {
            "level": 3
          },
          "content": [
            {
              "type": "text",
              "text": "√âtape 3 : Recevoir et afficher les messages"
            }
          ]
        },
        {
          "type": "paragraph",
          "content": [
            {
              "type": "text",
              "text": "Impl√©mentez la r√©ception des messages et leur affichage dans l'interface utilisateur :"
            }
          ]
        },
        {
          "type": "codeBlock",
          "attrs": {
            "language": "javascript"
          },
          "content": [
            {
              "type": "text",
              "text": "ws.onmessage = (event) => {\n  try {\n    const message = JSON.parse(event.data);\n    \n    // Afficher le message dans l'interface\n    displayMessage(message);\n    \n    // Optionnel : faire d√©filer vers le bas\n    scrollToBottom();\n  } catch (error) {\n    console.error('Erreur lors du parsing du message:', error);\n  }\n};\n\nfunction displayMessage(message) {\n  const messagesContainer = document.getElementById('messages');\n  const messageElement = document.createElement('div');\n  messageElement.className = 'message';\n  messageElement.innerHTML = `\n    <div class=\"message-header\">\n      <span class=\"user\">${message.user}</span>\n      <span class=\"timestamp\">${new Date(message.timestamp).toLocaleTimeString()}</span>\n    </div>\n    <div class=\"message-content\">${message.content}</div>\n  `;\n  messagesContainer.appendChild(messageElement);\n}"
            }
          ]
        },
        {
          "type": "heading",
          "attrs": {
            "level": 3
          },
          "content": [
            {
              "type": "text",
              "text": "√âtape 4 : Reconnexion automatique"
            }
          ]
        },
        {
          "type": "paragraph",
          "content": [
            {
              "type": "text",
              "text": "Impl√©mentez un syst√®me de reconnexion automatique avec un d√©lai exponentiel :"
            }
          ]
        },
        {
          "type": "codeBlock",
          "attrs": {
            "language": "javascript"
          },
          "content": [
            {
              "type": "text",
              "text": "class WebSocketClient {\n  constructor(url) {\n    this.url = url;\n    this.ws = null;\n    this.reconnectAttempts = 0;\n    this.maxReconnectAttempts = 5;\n    this.reconnectDelay = 1000; // 1 seconde initialement\n  }\n\n  connect() {\n    this.ws = new WebSocket(this.url);\n\n    this.ws.onopen = () => {\n      console.log('WebSocket connect√©');\n      this.reconnectAttempts = 0;\n      this.reconnectDelay = 1000; // R√©initialiser le d√©lai\n      this.startHeartbeat();\n    };\n\n    this.ws.onclose = () => {\n      console.log('WebSocket ferm√©');\n      this.stopHeartbeat();\n      this.attemptReconnect();\n    };\n\n    this.ws.onerror = (error) => {\n      console.error('Erreur WebSocket:', error);\n    };\n\n    this.ws.onmessage = (event) => {\n      const message = JSON.parse(event.data);\n      this.handleMessage(message);\n    };\n  }\n\n  attemptReconnect() {\n    if (this.reconnectAttempts < this.maxReconnectAttempts) {\n      this.reconnectAttempts++;\n      // D√©lai exponentiel : 1s, 2s, 4s, 8s, 16s (max 30s)\n      const delay = Math.min(\n        this.reconnectDelay * Math.pow(2, this.reconnectAttempts - 1),\n        30000\n      );\n      \n      console.log(`Tentative de reconnexion ${this.reconnectAttempts}/${this.maxReconnectAttempts} dans ${delay}ms...`);\n      \n      setTimeout(() => {\n        this.connect();\n      }, delay);\n    } else {\n      console.error('Nombre maximum de tentatives de reconnexion atteint');\n      // Afficher un message √† l'utilisateur\n      this.onMaxReconnectAttemptsReached();\n    }\n  }\n\n  onMaxReconnectAttemptsReached() {\n    // √Ä impl√©menter : afficher un message d'erreur √† l'utilisateur\n    console.error('Impossible de se reconnecter au serveur');\n  }\n}"
            }
          ]
        },
        {
          "type": "heading",
          "attrs": {
            "level": 3
          },
          "content": [
            {
              "type": "text",
              "text": "√âtape 5 : Syst√®me de heartbeat"
            }
          ]
        },
        {
          "type": "paragraph",
          "content": [
            {
              "type": "text",
              "text": "Impl√©mentez un syst√®me de heartbeat (ping/pong) pour maintenir la connexion active et d√©tecter les connexions mortes :"
            }
          ]
        },
        {
          "type": "codeBlock",
          "attrs": {
            "language": "javascript"
          },
          "content": [
            {
              "type": "text",
              "text": "startHeartbeat() {\n  // Envoyer un ping toutes les 30 secondes\n  this.heartbeatInterval = setInterval(() => {\n    if (this.ws && this.ws.readyState === WebSocket.OPEN) {\n      this.ws.send(JSON.stringify({ type: 'ping' }));\n      console.log('Ping envoy√©');\n    }\n  }, 30000); // 30 secondes\n\n  // Timeout pour d√©tecter si le serveur ne r√©pond pas\n  this.heartbeatTimeout = setTimeout(() => {\n    if (this.ws && this.ws.readyState === WebSocket.OPEN) {\n      console.warn('Pas de r√©ponse du serveur, fermeture de la connexion');\n      this.ws.close();\n    }\n  }, 35000); // 35 secondes (5 secondes apr√®s le ping)\n}\n\nstopHeartbeat() {\n  if (this.heartbeatInterval) {\n    clearInterval(this.heartbeatInterval);\n    this.heartbeatInterval = null;\n  }\n  if (this.heartbeatTimeout) {\n    clearTimeout(this.heartbeatTimeout);\n    this.heartbeatTimeout = null;\n  }\n}\n\n// Mettre √† jour le timeout lorsqu'on re√ßoit un pong\nws.onmessage = (event) => {\n  const message = JSON.parse(event.data);\n  \n  if (message.type === 'pong') {\n    console.log('Pong re√ßu');\n    // R√©initialiser le timeout\n    clearTimeout(this.heartbeatTimeout);\n    this.heartbeatTimeout = setTimeout(() => {\n      if (this.ws && this.ws.readyState === WebSocket.OPEN) {\n        console.warn('Pas de r√©ponse du serveur');\n        this.ws.close();\n      }\n    }, 35000);\n  } else {\n    this.handleMessage(message);\n  }\n};"
            }
          ]
        },
        {
          "type": "heading",
          "attrs": {
            "level": 2
          },
          "content": [
            {
              "type": "text",
              "text": "üíª Code de base complet"
            }
          ]
        },
        {
          "type": "paragraph",
          "content": [
            {
              "type": "text",
              "text": "Voici un exemple complet de classe WebSocketClient que vous pouvez utiliser comme point de d√©part :"
            }
          ]
        },
        {
          "type": "codeBlock",
          "attrs": {
            "language": "javascript"
          },
          "content": [
            {
              "type": "text",
              "text": "// Exemple de client WebSocket avec reconnexion et heartbeat\nclass WebSocketClient {\n  constructor(url) {\n    this.url = url;\n    this.ws = null;\n    this.reconnectAttempts = 0;\n    this.maxReconnectAttempts = 5;\n    this.reconnectDelay = 1000;\n    this.heartbeatInterval = null;\n    this.heartbeatTimeout = null;\n    this.onMessageCallback = null;\n    this.onConnectionChangeCallback = null;\n  }\n\n  connect() {\n    this.ws = new WebSocket(this.url);\n\n    this.ws.onopen = () => {\n      console.log('WebSocket connect√©');\n      this.reconnectAttempts = 0;\n      this.reconnectDelay = 1000;\n      this.startHeartbeat();\n      if (this.onConnectionChangeCallback) {\n        this.onConnectionChangeCallback('connected');\n      }\n    };\n\n    this.ws.onmessage = (event) => {\n      try {\n        const message = JSON.parse(event.data);\n        \n        if (message.type === 'pong') {\n          console.log('Pong re√ßu');\n          this.resetHeartbeatTimeout();\n        } else {\n          this.handleMessage(message);\n        }\n      } catch (error) {\n        console.error('Erreur lors du parsing du message:', error);\n      }\n    };\n\n    this.ws.onerror = (error) => {\n      console.error('Erreur WebSocket:', error);\n      if (this.onConnectionChangeCallback) {\n        this.onConnectionChangeCallback('error');\n      }\n    };\n\n    this.ws.onclose = () => {\n      console.log('WebSocket ferm√©');\n      this.stopHeartbeat();\n      if (this.onConnectionChangeCallback) {\n        this.onConnectionChangeCallback('disconnected');\n      }\n      this.attemptReconnect();\n    };\n  }\n\n  send(message) {\n    if (this.ws && this.ws.readyState === WebSocket.OPEN) {\n      this.ws.send(JSON.stringify(message));\n    } else {\n      console.error('WebSocket n'est pas connect√©');\n    }\n  }\n\n  startHeartbeat() {\n    this.heartbeatInterval = setInterval(() => {\n      if (this.ws && this.ws.readyState === WebSocket.OPEN) {\n        this.ws.send(JSON.stringify({ type: 'ping' }));\n        console.log('Ping envoy√©');\n        this.resetHeartbeatTimeout();\n      }\n    }, 30000); // Toutes les 30 secondes\n  }\n\n  resetHeartbeatTimeout() {\n    if (this.heartbeatTimeout) {\n      clearTimeout(this.heartbeatTimeout);\n    }\n    this.heartbeatTimeout = setTimeout(() => {\n      if (this.ws && this.ws.readyState === WebSocket.OPEN) {\n        console.warn('Pas de r√©ponse du serveur, fermeture de la connexion');\n        this.ws.close();\n      }\n    }, 35000); // 35 secondes\n  }\n\n  stopHeartbeat() {\n    if (this.heartbeatInterval) {\n      clearInterval(this.heartbeatInterval);\n      this.heartbeatInterval = null;\n    }\n    if (this.heartbeatTimeout) {\n      clearTimeout(this.heartbeatTimeout);\n      this.heartbeatTimeout = null;\n    }\n  }\n\n  attemptReconnect() {\n    if (this.reconnectAttempts < this.maxReconnectAttempts) {\n      this.reconnectAttempts++;\n      const delay = Math.min(\n        this.reconnectDelay * Math.pow(2, this.reconnectAttempts - 1),\n        30000\n      );\n      console.log(`Tentative de reconnexion ${this.reconnectAttempts}/${this.maxReconnectAttempts} dans ${delay}ms...`);\n      setTimeout(() => this.connect(), delay);\n    } else {\n      console.error('Nombre maximum de tentatives de reconnexion atteint');\n    }\n  }\n\n  handleMessage(message) {\n    if (this.onMessageCallback) {\n      this.onMessageCallback(message);\n    } else {\n      console.log('Message re√ßu:', message);\n    }\n  }\n\n  onMessage(callback) {\n    this.onMessageCallback = callback;\n  }\n\n  onConnectionChange(callback) {\n    this.onConnectionChangeCallback = callback;\n  }\n\n  disconnect() {\n    this.stopHeartbeat();\n    if (this.ws) {\n      this.ws.close();\n    }\n  }\n}\n\n// Utilisation\nconst client = new WebSocketClient('wss://echo.websocket.org');\n\nclient.onMessage((message) => {\n  console.log('Message re√ßu:', message);\n  // Afficher le message dans l'interface\n  displayMessage(message);\n});\n\nclient.onConnectionChange((status) => {\n  console.log('Statut de connexion:', status);\n  // Mettre √† jour l'interface (indicateur de connexion)\n  updateConnectionStatus(status);\n});\n\nclient.connect();\n\n// Envoyer un message\nfunction sendChatMessage(text) {\n  client.send({\n    type: 'message',\n    content: text,\n    timestamp: new Date().toISOString(),\n    user: 'MonNom'\n  });\n}"
            }
          ]
        },
        {
          "type": "heading",
          "attrs": {
            "level": 2
          },
          "content": [
            {
              "type": "text",
              "text": "üìù Interface HTML de base"
            }
          ]
        },
        {
          "type": "codeBlock",
          "attrs": {
            "language": "html"
          },
          "content": [
            {
              "type": "text",
              "text": "<!DOCTYPE html>\n<html lang=\"fr\">\n<head>\n  <meta charset=\"UTF-8\">\n  <meta name=\"viewport\" content=\"width=device-width, initial-scale=1.0\">\n  <title>Chat WebSocket</title>\n  <style>\n    body {\n      font-family: Arial, sans-serif;\n      max-width: 800px;\n      margin: 0 auto;\n      padding: 20px;\n    }\n    #status {\n      padding: 10px;\n      margin-bottom: 20px;\n      border-radius: 5px;\n      text-align: center;\n    }\n    .connected { background-color: #4CAF50; color: white; }\n    .disconnected { background-color: #f44336; color: white; }\n    .connecting { background-color: #ff9800; color: white; }\n    #messages {\n      border: 1px solid #ddd;\n      height: 400px;\n      overflow-y: auto;\n      padding: 10px;\n      margin-bottom: 20px;\n      background-color: #f9f9f9;\n    }\n    .message {\n      margin-bottom: 15px;\n      padding: 10px;\n      background-color: white;\n      border-radius: 5px;\n      box-shadow: 0 1px 2px rgba(0,0,0,0.1);\n    }\n    .message-header {\n      display: flex;\n      justify-content: space-between;\n      margin-bottom: 5px;\n      font-size: 0.9em;\n      color: #666;\n    }\n    .message-content {\n      color: #333;\n    }\n    #messageForm {\n      display: flex;\n      gap: 10px;\n    }\n    #messageInput {\n      flex: 1;\n      padding: 10px;\n      border: 1px solid #ddd;\n      border-radius: 5px;\n    }\n    #sendButton {\n      padding: 10px 20px;\n      background-color: #4CAF50;\n      color: white;\n      border: none;\n      border-radius: 5px;\n      cursor: pointer;\n    }\n    #sendButton:hover {\n      background-color: #45a049;\n    }\n    #sendButton:disabled {\n      background-color: #ccc;\n      cursor: not-allowed;\n    }\n  </style>\n</head>\n<body>\n  <h1>üí¨ Chat WebSocket</h1>\n  \n  <div id=\"status\" class=\"disconnected\">D√©connect√©</div>\n  \n  <div id=\"messages\"></div>\n  \n  <form id=\"messageForm\">\n    <input \n      type=\"text\" \n      id=\"messageInput\" \n      placeholder=\"Tapez votre message...\" \n      disabled\n    />\n    <button type=\"submit\" id=\"sendButton\" disabled>Envoyer</button>\n  </form>\n\n  <script src=\"websocket-client.js\"></script>\n  <script src=\"app.js\"></script>\n</body>\n</html>"
            }
          ]
        },
        {
          "type": "heading",
          "attrs": {
            "level": 2
          },
          "content": [
            {
              "type": "text",
              "text": "üîó Ressources suppl√©mentaires"
            }
          ]
        },
        {
          "type": "bulletList",
          "content": [
            {
              "type": "listItem",
              "content": [
                {
                  "type": "paragraph",
                  "content": [
                    {
                      "type": "text",
                      "text": "Documentation MDN WebSocket : "
                    },
                    {
                      "type": "text",
                      "marks": [
                        {
                          "type": "link",
                          "attrs": {
                            "href": "https://developer.mozilla.org/fr/docs/Web/API/WebSocket",
                            "target": "_blank"
                          }
                        }
                      ],
                      "text": "developer.mozilla.org/fr/docs/Web/API/WebSocket"
                    }
                  ]
                }
              ]
            },
            {
              "type": "listItem",
              "content": [
                {
                  "type": "paragraph",
                  "content": [
                    {
                      "type": "text",
                      "text": "RFC 6455 - WebSocket Protocol : "
                    },
                    {
                      "type": "text",
                      "marks": [
                        {
                          "type": "link",
                          "attrs": {
                            "href": "https://tools.ietf.org/html/rfc6455",
                            "target": "_blank"
                          }
                        }
                      ],
                      "text": "tools.ietf.org/html/rfc6455"
                    }
                  ]
                }
              ]
            },
            {
              "type": "listItem",
              "content": [
                {
                  "type": "paragraph",
                  "content": [
                    {
                      "type": "text",
                      "text": "Socket.io - Biblioth√®que WebSocket populaire : "
                    },
                    {
                      "type": "text",
                      "marks": [
                        {
                          "type": "link",
                          "attrs": {
                            "href": "https://socket.io",
                            "target": "_blank"
                          }
                        }
                      ],
                      "text": "socket.io"
                    }
                  ]
                }
              ]
            },
            {
              "type": "listItem",
              "content": [
                {
                  "type": "paragraph",
                  "content": [
                    {
                      "type": "text",
                      "text": "WebSocket.org - Outils de test : "
                    },
                    {
                      "type": "text",
                      "marks": [
                        {
                          "type": "link",
                          "attrs": {
                            "href": "https://www.websocket.org/echo.html",
                            "target": "_blank"
                          }
                        }
                      ],
                      "text": "websocket.org/echo.html"
                    }
                  ]
                }
              ]
            }
          ]
        }
      ]
    },
    "checklist": [
      "Cr√©er la structure HTML de base avec un formulaire de message et une zone d'affichage",
      "Impl√©menter la classe WebSocketClient avec les m√©thodes connect(), send(), et disconnect()",
      "G√©rer les √©v√©nements onopen, onmessage, onerror, et onclose",
      "Impl√©menter l'envoi de messages avec format JSON (type, content, timestamp, user)",
      "Impl√©menter la r√©ception et l'affichage des messages dans l'interface",
      "Ajouter la gestion de reconnexion automatique avec d√©lai exponentiel",
      "Impl√©menter le syst√®me de heartbeat (ping/pong) toutes les 30 secondes",
      "Ajouter un timeout pour d√©tecter les connexions mortes",
      "Afficher le statut de connexion (connect√©/d√©connect√©/en cours de connexion)",
      "G√©rer les erreurs et afficher des messages appropri√©s √† l'utilisateur",
      "Tester la reconnexion en simulant une perte de connexion",
      "Tester le heartbeat en v√©rifiant que les pings sont envoy√©s r√©guli√®rement",
      "Ajouter la possibilit√© de saisir un nom d'utilisateur",
      "Am√©liorer l'interface avec du CSS pour un rendu plus professionnel",
      "Ajouter un d√©filement automatique vers le bas lors de l'arriv√©e de nouveaux messages"
    ]
  }
}

